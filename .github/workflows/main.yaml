name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      GHCR_USERNAME: ${{ github.actor }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      IMAGE_NAMESPACE: ghcr.io/hydpe/microservices_main

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USERNAME }}
          password: ${{ env.GHCR_TOKEN }}

      # -------------------- API Gateway --------------------
      - name: Build and push ApiGateway image
        run: |
          docker build -t $IMAGE_NAMESPACE/api-gateway:latest ./ApiGateway
          docker push $IMAGE_NAMESPACE/api-gateway:latest

      - name: Trigger Render deployment for ApiGateway
        run: |
          curl -X POST "${{ secrets.APIGATEWAY_DEPLOY_HOOK }}"

      # -------------------- Auth Service --------------------
      - name: Build and push AuthService image
        run: |
          docker build -t $IMAGE_NAMESPACE/auth-service:latest ./AuthService
          docker push $IMAGE_NAMESPACE/auth-service:latest

      - name: Trigger Render deployment for AuthService
        run: |
          curl -X POST "${{ secrets.AUTHSERVICE_DEPLOY_HOOK }}"

      # -------------------- Student Service --------------------
      - name: Build and push StudentService1 image
        run: |
          docker build -t $IMAGE_NAMESPACE/student-service1:latest ./StudentService
          docker push $IMAGE_NAMESPACE/student-service1:latest

      - name: Trigger Render deployment for StudentService1
        run: |
          curl -X POST "${{ secrets.STUDENT_DEPLOY_HOOK }}"

      # -------------------- Service Registry --------------------
      - name: Build and push ServiceRegistry image
        run: |
          docker build -t $IMAGE_NAMESPACE/service-registry:latest ./ServiceRegistry
          docker push $IMAGE_NAMESPACE/service-registry:latest

      - name: Trigger Render deployment for ServiceRegistry
        run: |
          curl -X POST "${{ secrets.REGISTRY_DEPLOY_HOOK }}"
